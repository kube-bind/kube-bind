{{- if .Values.gatewayApi.enabled }}
{{- if .Values.certManager.enabled }}
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ include "kube-bind.fullname" . }}-tls
  labels:
    {{- include "kube-bind.labels" . | nindent 4 }}
spec:
  secretName: {{ include "kube-bind.fullname" . }}-tls
  issuerRef:
    name: {{ .Values.certManager.clusterIssuer }}
    kind: ClusterIssuer
  {{- if .Values.gatewayApi.route.hostnames }}
  dnsNames:
  {{- range .Values.gatewayApi.route.hostnames }}
  - {{ . }}
  {{- end }}
  {{- end }}
---
{{- end }}
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: {{ include "kube-bind.fullname" . }}-gateway
  labels:
    {{- include "kube-bind.labels" . | nindent 4 }}
  {{- with .Values.gatewayApi.gateway.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  gatewayClassName: {{ .Values.gatewayApi.gateway.className }}
  listeners:
  - name: https
    protocol: HTTPS
    port: {{ .Values.gatewayApi.gateway.httpsPort | default 443 }}
    tls:
      mode: Terminate
      certificateRefs:
      {{- if .Values.certManager.enabled }}
      - name: {{ include "kube-bind.fullname" . }}-tls
      {{- else if .Values.gatewayApi.gateway.tls.certificateRefs }}
      {{- range .Values.gatewayApi.gateway.tls.certificateRefs }}
      - name: {{ .name }}
        {{- if .namespace }}
        namespace: {{ .namespace }}
        {{- end }}
        {{- if .group }}
        group: {{ .group }}
        {{- end }}
        {{- if .kind }}
        kind: {{ .kind }}
        {{- end }}
      {{- end }}
      {{- end }}
  - name: http
    protocol: HTTP
    port: {{ .Values.gatewayApi.gateway.httpPort | default 80 }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ include "kube-bind.fullname" . }}-route
  labels:
    {{- include "kube-bind.labels" . | nindent 4 }}
  {{- with .Values.gatewayApi.route.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  parentRefs:
  - name: {{ include "kube-bind.fullname" . }}-gateway
  {{- if .Values.gatewayApi.route.hostnames }}
  hostnames:
  {{- range .Values.gatewayApi.route.hostnames }}
  - {{ . | quote }}
  {{- end }}
  {{- end }}
  rules:
  - matches:
    - path:
        type: {{ .Values.gatewayApi.route.pathType | default "PathPrefix" }}
        value: {{ .Values.gatewayApi.route.path | default "/" }}
    backendRefs:
    - name: {{ include "kube-bind.fullname" . }}
      port: {{ .Values.service.port }}
{{- end }}